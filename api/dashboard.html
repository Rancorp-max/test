<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Petsona Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors:{ forest:"#0d1f1a", forest2:"#122820", cream:"#fff7ea", gold:"#d4af37" },
          boxShadow:{ frame:"0 0 0 1px rgba(212,175,55,.45), inset 0 0 0 1px rgba(255,255,255,.08)" }
        }
      }
    }
  </script>
  <style>
    body{ background:#0d1f1a; color:#fff; }
    .card{ background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.12); border-radius:16px; }
    .table-head th{ position:sticky; top:0; background:rgba(13,31,26,.98); }
    .link{ color:#d4af37; }
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-30 backdrop-blur-md">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-full grid place-items-center bg-cream">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="#d4af37" aria-hidden="true"><path d="M3 7l4 3 5-6 5 6 4-3v10H3z"/></svg>
        </div>
        <div>
          <div class="text-xl font-extrabold">Petsona Dashboard</div>
          <div class="text-xs text-white/70">Leads & conversions</div>
        </div>
      </div>
      <a href="/" class="text-sm text-white/80 hover:text-white">← Back to site</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 pb-20">
    <!-- KPIs -->
    <section class="grid md:grid-cols-3 gap-3 my-4">
      <div class="card p-4">
        <div class="text-xs text-white/70">Total Leads</div>
        <div id="mTotal" class="text-3xl font-bold mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-xs text-white/70">Opt-in Rate</div>
        <div id="mOptin" class="text-3xl font-bold mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-xs text-white/70">Top Persona</div>
        <div id="mTopPersona" class="text-3xl font-bold mt-1">—</div>
      </div>
    </section>

    <!-- Controls + table -->
    <section class="card p-4">
      <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
        <div class="flex gap-2 items-center">
          <input id="q" placeholder="Search email or persona…" class="w-64 max-w-full bg-transparent border border-white/20 rounded-lg px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-gold"/>
          <button id="btnSearch" class="text-sm px-3 py-2 border border-white/20 rounded-lg hover:bg-white/10">Search</button>
          <button id="btnClear" class="text-sm px-3 py-2 border border-white/20 rounded-lg hover:bg-white/10">Clear</button>
        </div>
        <div class="flex gap-2">
          <button id="btnExport" class="text-sm px-3 py-2 border border-white/20 rounded-lg hover:bg-white/10">Export CSV</button>
          <span id="status" class="text-xs text-white/60 self-center"></span>
        </div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="min-w-full text-sm">
          <thead class="table-head">
            <tr class="text-left text-white/80">
              <th class="px-3 py-2 cursor-pointer" data-sort="timestamp">Timestamp</th>
              <th class="px-3 py-2 cursor-pointer" data-sort="email">Email</th>
              <th class="px-3 py-2 cursor-pointer" data-sort="marketing_opt_in">Opt-in</th>
              <th class="px-3 py-2 cursor-pointer" data-sort="persona">Persona</th>
              <th class="px-3 py-2">Image</th>
              <th class="px-3 py-2">UA</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="flex items-center justify-between mt-4 text-xs">
        <div id="pagerText" class="text-white/70">—</div>
        <div class="flex gap-2">
          <button id="prev" class="px-3 py-1.5 border border-white/20 rounded hover:bg-white/10">Prev</button>
          <button id="next" class="px-3 py-1.5 border border-white/20 rounded hover:bg-white/10">Next</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    let rows = [];
    let total = 0;
    let limit = 1000;
    let offset = 0;
    let search = '';
    let sortKey = 'timestamp';
    let sortDir = 'desc';

    const tbody = document.getElementById('tbody');
    const mTotal = document.getElementById('mTotal');
    const mOptin = document.getElementById('mOptin');
    const mTopPersona = document.getElementById('mTopPersona');
    const pagerText = document.getElementById('pagerText');
    const status = document.getElementById('status');
    const q = document.getElementById('q');

    async function fetchData(){
      status.textContent = 'Loading…';
      const params = new URLSearchParams({ limit, offset, search });
      const res = await fetch(`/api/leads?${params.toString()}`);
      const data = await res.json();
      rows = data.rows || [];
      total = data.total || rows.length;
      status.textContent = '';
      render();
    }

    function render(){
      rows.sort((a,b)=>{
        const va = (a[sortKey] || '').toString().toLowerCase();
        const vb = (b[sortKey] || '').toString().toLowerCase();
        if (va === vb) return 0;
        return sortDir === 'asc' ? (va < vb ? -1 : 1) : (va > vb ? -1 : 1);
      });

      tbody.innerHTML = rows.map(r => {
        const ts = r.timestamp ? new Date(r.timestamp).toLocaleString() : '';
        const opt = r.marketing_opt_in || '';
        const img = r.image ? `<a href="${r.image}" class="link" target="_blank" rel="noopener">Open</a>` : '';
        const ua = (r.user_agent || '').slice(0, 50) + ((r.user_agent || '').length > 50 ? '…' : '');
        return `
          <tr class="border-t border-white/10 hover:bg-white/5">
            <td class="px-3 py-2 whitespace-nowrap">${ts}</td>
            <td class="px-3 py-2">${r.email || ''}</td>
            <td class="px-3 py-2">${opt}</td>
            <td class="px-3 py-2">${r.persona || ''}</td>
            <td class="px-3 py-2">${img}</td>
            <td class="px-3 py-2">${ua}</td>
          </tr>
        `;
      }).join('');

      mTotal.textContent = total.toLocaleString();
      const optins = rows.filter(r => (r.marketing_opt_in || '').toLowerCase().startsWith('y')).length;
      const optRate = total ? Math.round((optins / total) * 100) : 0;
      mOptin.textContent = total ? `${optRate}%` : '—';
      const counts = {};
      rows.forEach(r => { const k = r.persona || '—'; counts[k] = (counts[k] || 0) + 1; });
      const top = Object.entries(counts).sort((a,b)=>b[1]-a[1])[0];
      mTopPersona.textContent = top ? `${top[0]} (${top[1]})` : '—';

      const start = total ? (offset + 1) : 0;
      const end = Math.min(offset + limit, total);
      pagerText.textContent = total ? `Showing ${start}-${end} of ${total}` : 'No data';
    }

    document.querySelectorAll('th[data-sort]').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key = th.getAttribute('data-sort');
        if (sortKey === key) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
        else { sortKey = key; sortDir = 'asc'; }
        render();
      });
    });

    document.getElementById('btnSearch').addEventListener('click', ()=>{ search = q.value.trim(); offset = 0; fetchData(); });
    document.getElementById('btnClear').addEventListener('click', ()=>{ q.value=''; search=''; offset=0; fetchData(); });

    document.getElementById('prev').addEventListener('click', ()=>{
      offset = Math.max(0, offset - limit);
      fetchData();
    });
    document.getElementById('next').addEventListener('click', ()=>{
      if (offset + limit < total) { offset += limit; fetchData(); }
    });

    function toCSV(arr){
      const head = ['timestamp','email','marketing_opt_in','persona','image','user_agent'];
      const esc = (v) => `"${String(v ?? '').replace(/"/g,'""')}"`;
      const lines = [head.join(',')].concat(arr.map(r=> head.map(h=>esc(r[h])).join(',')));
      return lines.join('\n');
    }
    document.getElementById('btnExport').addEventListener('click', async ()=>{
      const res = await fetch(`/api/leads?limit=5000`);
      const data = await res.json();
      const csv = toCSV(data.rows || []);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `petsona-leads-${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    fetchData();
  </script>
</body>
</html>
